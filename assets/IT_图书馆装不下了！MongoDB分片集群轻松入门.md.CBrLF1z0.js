import{_ as s,o as i,c as a,a7 as t}from"./chunks/framework.CmR4KQfH.js";const u=JSON.parse('{"title":"图书馆装不下了！MongoDB分片集群轻松入门","description":"","frontmatter":{"title":"图书馆装不下了！MongoDB分片集群轻松入门","date":"2025-11-17T14:56:35.000Z","tags":["MongoDB"],"categories":["IT"]},"headers":[],"relativePath":"IT/图书馆装不下了！MongoDB分片集群轻松入门.md","filePath":"IT/图书馆装不下了！MongoDB分片集群轻松入门.md","lastUpdated":1763453734000}'),n={name:"IT/图书馆装不下了！MongoDB分片集群轻松入门.md"},l=t(`<h1 id="图书馆装不下了-mongodb分片集群轻松入门" tabindex="-1">图书馆装不下了！MongoDB分片集群轻松入门 <a class="header-anchor" href="#图书馆装不下了-mongodb分片集群轻松入门" aria-label="Permalink to &quot;图书馆装不下了！MongoDB分片集群轻松入门&quot;">​</a></h1><blockquote><p>从单一图书馆到图书馆联盟，看懂分片的本质</p></blockquote><h2 id="为什么图书馆会-装不下" tabindex="-1">为什么图书馆会&quot;装不下&quot;？ <a class="header-anchor" href="#为什么图书馆会-装不下" aria-label="Permalink to &quot;为什么图书馆会&quot;装不下&quot;？&quot;">​</a></h2><p>想象一下，你管理的图书馆最初只有1万本书，一切井井有条。但几年后：</p><p><strong>现实问题出现了：</strong></p><ul><li>📚 藏书从1万册增长到<strong>1000万册</strong></li><li>📊 书架使用率超过<strong>95%</strong>，新书无处可放</li><li>⏱️ 找一本书从<strong>1分钟变成10分钟</strong></li><li>😫 借书排队从<strong>5分钟变成半小时</strong></li></ul><p>这就像单个MongoDB数据库遇到瓶颈：</p><ul><li>存储空间不足</li><li>查询速度变慢</li><li>并发访问卡顿</li></ul><h2 id="解决方案-建立-图书馆联盟" tabindex="-1">解决方案：建立&quot;图书馆联盟&quot; <a class="header-anchor" href="#解决方案-建立-图书馆联盟" aria-label="Permalink to &quot;解决方案：建立&quot;图书馆联盟&quot;&quot;">​</a></h2><p>既然一个图书馆装不下，那就建<strong>多个图书馆</strong>，组成联盟！</p><h3 id="联盟的三大核心角色" tabindex="-1">联盟的三大核心角色： <a class="header-anchor" href="#联盟的三大核心角色" aria-label="Permalink to &quot;联盟的三大核心角色：&quot;">​</a></h3><p><strong>🏛️ 总服务台（mongos路由）</strong></p><ul><li>读者唯一的入口</li><li>问它&quot;书在哪里&quot;，它告诉你该去哪个分馆</li></ul><p><strong>📋 中央目录（配置服务器）</strong></p><ul><li>记录每本书在哪个分馆</li><li>有3个备份，防止目录丢失</li></ul><p><strong>🏢 分区图书馆（分片）</strong></p><ul><li>每个分馆存放不同范围的书</li><li>可以同时服务不同区域的读者</li></ul><h2 id="三种分书方案-哪种更适合你" tabindex="-1">三种分书方案，哪种更适合你？ <a class="header-anchor" href="#三种分书方案-哪种更适合你" aria-label="Permalink to &quot;三种分书方案，哪种更适合你？&quot;">​</a></h2><h3 id="方案一-按类别分馆-范围分片" tabindex="-1">方案一：按类别分馆（范围分片） <a class="header-anchor" href="#方案一-按类别分馆-范围分片" aria-label="Permalink to &quot;方案一：按类别分馆（范围分片）&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文学类 → A馆，科技类 → B馆，历史类 → C馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sh.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shardCollection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;library.books&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {category: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><p><strong>👍 优点：</strong></p><ul><li>同类书籍在一起，找书方便</li><li>适合经常按类别查询的场景</li></ul><p><strong>👎 缺点：</strong></p><ul><li>如果科技书突然火爆，B馆压力巨大</li><li>可能出现&quot;热门分馆&quot;现象</li></ul><p><strong>适合场景</strong>：查询经常按固定范围（如时间、类别）</p><h3 id="方案二-随机分配-哈希分片" tabindex="-1">方案二：随机分配（哈希分片） <a class="header-anchor" href="#方案二-随机分配-哈希分片" aria-label="Permalink to &quot;方案二：随机分配（哈希分片）&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 对书号进行哈希，随机分配到各馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sh.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shardCollection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;library.books&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {book_id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hashed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><p><strong>👍 优点：</strong></p><ul><li>绝对均衡，不会出现单点过热</li><li>写入性能最佳</li></ul><p><strong>👎 缺点：</strong></p><ul><li>找同类书籍需要跑遍所有分馆</li><li>范围查询性能差</li></ul><p><strong>适合场景</strong>：写入密集，没有明显范围查询</p><h3 id="方案三-按读者区域分馆-标签分片" tabindex="-1">方案三：按读者区域分馆（标签分片） <a class="header-anchor" href="#方案三-按读者区域分馆-标签分片" aria-label="Permalink to &quot;方案三：按读者区域分馆（标签分片）&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 南山读者去A馆，宝安读者去B馆</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 按行政区划分片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sh.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addShardTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;nanshan_shard&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;nanshan_region&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 南山分馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sh.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addShardTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;baoan_shard&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;baoan_region&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 宝安分馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sh.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addShardTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;futian_shard&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;futian_region&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 福田分馆</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 读者数据按区域分布</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sh.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addTagRange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;shenzhen_library.readers&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {district: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;南山区&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, {district: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;南山区&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;nanshan_region&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sh.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addTagRange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;shenzhen_library.readers&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {district: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;宝安区&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, {district: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;宝安区&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;baoan_region&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sh.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addTagRange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;shenzhen_library.readers&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {district: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;福田区&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, {district: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;福田区&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;futian_region&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><strong>👍 优点：</strong></p><ul><li>读者访问速度快</li><li>网络延迟低</li></ul><p><strong>👎 缺点：</strong></p><ul><li>数据分布可能不均衡</li><li>读者搬家后可能变慢</li></ul><p><strong>适合场景</strong>：有明显地域特征的业务</p><h2 id="什么时候需要考虑分片" tabindex="-1">什么时候需要考虑分片？ <a class="header-anchor" href="#什么时候需要考虑分片" aria-label="Permalink to &quot;什么时候需要考虑分片？&quot;">​</a></h2><p><strong>需要分片的信号：</strong></p><ul><li>💾 数据量接近单机存储极限（如超过500GB）</li><li>⚡ 查询性能明显下降（简单查询超过3秒）</li><li>👥 并发用户数大幅增长（超过1000并发）</li><li>📈 业务预计未来1年有爆发式增长</li></ul><p><strong>还可以再等等的情况：</strong></p><ul><li>当前架构还能支撑业务发展</li><li>团队对分片技术还不熟悉</li><li>业务模式还在探索阶段</li></ul><h2 id="常见误区提醒" tabindex="-1">常见误区提醒 <a class="header-anchor" href="#常见误区提醒" aria-label="Permalink to &quot;常见误区提醒&quot;">​</a></h2><h3 id="❌-误区1-分片越早越好" tabindex="-1">❌ 误区1：分片越早越好 <a class="header-anchor" href="#❌-误区1-分片越早越好" aria-label="Permalink to &quot;❌ 误区1：分片越早越好&quot;">​</a></h3><p><strong>真相</strong>：分片增加复杂度，应该在真正需要时才用</p><h3 id="❌-误区2-一分片就万事大吉" tabindex="-1">❌ 误区2：一分片就万事大吉 <a class="header-anchor" href="#❌-误区2-一分片就万事大吉" aria-label="Permalink to &quot;❌ 误区2：一分片就万事大吉&quot;">​</a></h3><p><strong>真相</strong>：分片键选错可能导致性能更差</p><h3 id="❌-误区3-分片可以替代索引" tabindex="-1">❌ 误区3：分片可以替代索引 <a class="header-anchor" href="#❌-误区3-分片可以替代索引" aria-label="Permalink to &quot;❌ 误区3：分片可以替代索引&quot;">​</a></h3><p><strong>真相</strong>：分片和索引是互补关系，不是替代关系</p><h2 id="总结-分片其实很简单" tabindex="-1">总结：分片其实很简单 <a class="header-anchor" href="#总结-分片其实很简单" aria-label="Permalink to &quot;总结：分片其实很简单&quot;">​</a></h2><p><strong>核心思想</strong>：一个装不下，就分成多个！</p><p>不确定要不要分片？先做个压力测试，模拟大量数据读写，监控性能变化。</p><p>如果性能下降明显，就该考虑分片了！</p><p><strong>选择方案的关键</strong>：看你的业务怎么查数据</p><ul><li>经常按范围查？→ 用范围分片</li><li>主要是写入和随机查？→ 用哈希分片</li><li>有明显地域特征？→ 用标签分片</li></ul><p><strong>记住</strong>：分片不是万能药，但确实是应对海量数据的好方法。</p>`,58),h=[l];function p(e,r,k,o,d,E){return i(),a("div",{"data-pagefind-body":!0},h)}const c=s(n,[["render",p]]);export{u as __pageData,c as default};
