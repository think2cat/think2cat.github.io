import{_ as s,o as i,c as a,a7 as n}from"./chunks/framework.CmR4KQfH.js";const c=JSON.parse('{"title":"MongoDB复制集：图书馆的“备份分馆”机制","description":"","frontmatter":{"title":"MongoDB复制集：图书馆的“备份分馆”机制","date":"2026-01-15T16:52:44.000Z","tags":["MongoDB"],"categories":["IT"]},"headers":[],"relativePath":"IT/MongoDB复制集.md","filePath":"IT/MongoDB复制集.md","lastUpdated":1771073478000}'),h={name:"IT/MongoDB复制集.md"},l=n(`<h1 id="mongodb复制集-图书馆的-备份分馆-机制" tabindex="-1">MongoDB复制集：图书馆的“备份分馆”机制 <a class="header-anchor" href="#mongodb复制集-图书馆的-备份分馆-机制" aria-label="Permalink to &quot;MongoDB复制集：图书馆的“备份分馆”机制&quot;">​</a></h1><h2 id="上期回顾-vs-本期预告" tabindex="-1">上期回顾 vs 本期预告 <a class="header-anchor" href="#上期回顾-vs-本期预告" aria-label="Permalink to &quot;上期回顾 vs 本期预告&quot;">​</a></h2><p><strong>上期《分片集群》讲的是</strong>：</p><blockquote><p>如何把1000万册书<strong>分到不同分馆</strong>（福田馆放文学、宝安馆放科技...）</p></blockquote><p><strong>本期《复制集》讲的是</strong>：</p><blockquote><p>如何为每个分馆<strong>建立备份馆</strong>（福田馆有备份、南山馆有备份...）</p></blockquote><h2 id="引言-一场真实的-故障演练" tabindex="-1">引言：一场真实的“故障演练” <a class="header-anchor" href="#引言-一场真实的-故障演练" aria-label="Permalink to &quot;引言：一场真实的“故障演练”&quot;">​</a></h2><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 这是深圳图书馆监控中心的一天</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">主图书馆电力故障：❌</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">读者借阅服务中断：✅</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">图书管理员手忙脚乱：❌</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">读者投诉电话：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 秘密就在于...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">复制集：✅✅✅</span></span></code></pre></div><h2 id="一、复制集-图书馆联盟的-分身术" tabindex="-1">一、复制集 = 图书馆联盟的“分身术” <a class="header-anchor" href="#一、复制集-图书馆联盟的-分身术" aria-label="Permalink to &quot;一、复制集 = 图书馆联盟的“分身术”&quot;">​</a></h2><h3 id="现实场景对比" tabindex="-1">现实场景对比 <a class="header-anchor" href="#现实场景对比" aria-label="Permalink to &quot;现实场景对比&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>🏢 深圳图书馆总部（主馆）   ← 你常去的那个</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>📚 南山区备份分馆（副本1）  ← 读者不知道的存在</span></span>
<span class="line"><span>📚 福田区备份分馆（副本2）  ← 另一个秘密基地</span></span>
<span class="line"><span>📚 宝安区备份分馆（副本3）  ← 最后的安全网</span></span></code></pre></div><h3 id="mongodb-中的对应关系" tabindex="-1">MongoDB 中的对应关系 <a class="header-anchor" href="#mongodb-中的对应关系" aria-label="Permalink to &quot;MongoDB 中的对应关系&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3个节点的复制集配置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> replicaSet</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  primary: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mongodb0:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 主节点 = 主图书馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  secondary1: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mongodb1:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 从节点1 = 南山分馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  secondary2: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mongodb2:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 从节点2 = 福田分馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  arbiter: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mongodb3:27017&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 仲裁节点 = 监督委员会</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h2 id="二、复制集如何工作-借书的完整流程" tabindex="-1">二、复制集如何工作？（借书的完整流程） <a class="header-anchor" href="#二、复制集如何工作-借书的完整流程" aria-label="Permalink to &quot;二、复制集如何工作？（借书的完整流程）&quot;">​</a></h2><h3 id="场景-读者借阅《三体》" tabindex="-1">场景：读者借阅《三体》 <a class="header-anchor" href="#场景-读者借阅《三体》" aria-label="Permalink to &quot;场景：读者借阅《三体》&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 步骤1：读者在自助机借书（写操作）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">读者 → 主图书馆：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;借《三体》一本&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">主图书馆 → 数据库：db.books.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {title: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;三体&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {$inc: {stock: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 步骤2：主图书馆同步到分馆（数据复制）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">主图书馆 → 南山分馆：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;《三体》库存-1&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">主图书馆 → 福田分馆：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;《三体》库存-1&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">主图书馆 → 宝安分馆：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;《三体》库存-1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 步骤3：读者收到确认</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">数据库 → 读者：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;借阅成功，当前库存：3本&quot;</span></span></code></pre></div><h3 id="实际配置代码" tabindex="-1">实际配置代码 <a class="header-anchor" href="#实际配置代码" aria-label="Permalink to &quot;实际配置代码&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 初始化一个3节点复制集</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">initiate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  _id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;shenzhen_lib&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复制集名称</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  members: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, host: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sz-lib-main:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 主馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, host: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sz-lib-nanshan:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 南山分馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, host: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sz-lib-futian:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 福田分馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 查看复制集状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 输出：3个节点，1个主节点，2个从节点</span></span></code></pre></div><h2 id="三、当主图书馆-停电-时-故障自动转移" tabindex="-1">三、当主图书馆“停电”时（故障自动转移） <a class="header-anchor" href="#三、当主图书馆-停电-时-故障自动转移" aria-label="Permalink to &quot;三、当主图书馆“停电”时（故障自动转移）&quot;">​</a></h2><h3 id="惊心动魄的60秒" tabindex="-1">惊心动魄的60秒 <a class="header-anchor" href="#惊心动魄的60秒" aria-label="Permalink to &quot;惊心动魄的60秒&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 时间线：主馆故障自动恢复</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">0</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:  主图书馆突然停电！⚡</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">10</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: 读者借书失败：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;系统繁忙，排队中，请稍候&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">15</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: 南山分馆发现联系不上主馆：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;大哥失联了？&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">20</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: 福田分馆也发现异常：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;确认主馆掉线&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">30</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: 紧急选举开始：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;谁来当新馆长？&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">45</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: 南山分馆当选新主馆！👑</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">50</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: 所有借书请求自动转到南山分馆</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">60</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: 读者继续借书，毫无察觉</span></span></code></pre></div><h3 id="mongodb-自动故障转移配置" tabindex="-1">MongoDB 自动故障转移配置 <a class="header-anchor" href="#mongodb-自动故障转移配置" aria-label="Permalink to &quot;MongoDB 自动故障转移配置&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 心跳检测：分馆之间互相&quot;打电话&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> heartbeat </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  interval: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 每2秒打一次电话</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  timeout: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 10秒不接就判定失联</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 选举超时设置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">settings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  electionTimeoutMillis: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 10秒选举超时</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  heartbeatTimeoutSecs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 心跳超时</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reconfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(settings);</span></span></code></pre></div><h2 id="四、不只是备份-复制集的5个高级功能" tabindex="-1">四、不只是备份（复制集的5个高级功能） <a class="header-anchor" href="#四、不只是备份-复制集的5个高级功能" aria-label="Permalink to &quot;四、不只是备份（复制集的5个高级功能）&quot;">​</a></h2><h3 id="功能1-读写分离-分流读者压力" tabindex="-1">功能1：读写分离 - 分流读者压力 <a class="header-anchor" href="#功能1-读写分离-分流读者压力" aria-label="Permalink to &quot;功能1：读写分离 - 分流读者压力&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 配置从节点可读</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db.books.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">find</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">readPref</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;secondary&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 实际效果：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">读者查询书籍信息 → 南山分馆（从节点）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">读者借书还书操作 → 主图书馆（主节点）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">管理员统计报表 → 福田分馆（从节点）</span></span></code></pre></div><h3 id="功能2-延迟节点-防止误操作" tabindex="-1">功能2：延迟节点 - 防止误操作 <a class="header-anchor" href="#功能2-延迟节点-防止误操作" aria-label="Permalink to &quot;功能2：延迟节点 - 防止误操作&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 创建一个延迟1小时的&quot;时间胶囊&quot;分馆</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  host: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sz-lib-delay:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  priority: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 不能成为主节点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  slaveDelay: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3600</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 延迟1小时</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 使用场景：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">早上9点：管理员误删了所有科幻小说 ❌</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">早上10点：从延迟节点恢复数据 ✅</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">读者：完全没察觉到这个</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;小事故&quot;</span></span></code></pre></div><h3 id="功能3-隐藏节点-数据分析专用" tabindex="-1">功能3：隐藏节点 - 数据分析专用 <a class="header-anchor" href="#功能3-隐藏节点-数据分析专用" aria-label="Permalink to &quot;功能3：隐藏节点 - 数据分析专用&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 创建隐藏节点，专门做数据分析</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  host: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sz-lib-analytics:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  priority: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 不参与选举</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  hidden: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 对读者隐藏</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 只用于后台任务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runCommand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  aggregate: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;borrow_records&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  pipeline: [</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  readConcern: {level: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;available&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h2 id="五、复制集监控-图书馆健康检查" tabindex="-1">五、复制集监控（图书馆健康检查） <a class="header-anchor" href="#五、复制集监控-图书馆健康检查" aria-label="Permalink to &quot;五、复制集监控（图书馆健康检查）&quot;">​</a></h2><h3 id="健康检查面板" tabindex="-1">健康检查面板 <a class="header-anchor" href="#健康检查面板" aria-label="Permalink to &quot;健康检查面板&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 查看复制集状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printReplicationInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 输出示例：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">图书馆集群状态：✅ 健康</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">┌────────────────┬─────────────────────┐</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│ 分馆名称       │ 状态      │ 延迟   │</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">├────────────────┼──────────┼─────────┤</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│ 主图书馆       │ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PRIMARY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  │ 0秒    │</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│ 南山分馆       │ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SECONDARY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│ 0.1秒  │</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│ 福田分馆       │ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SECONDARY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│ 0.2秒  │</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">└────────────────┴──────────┴─────────┘</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">同步延迟：在可接受范围内 ✅</span></span></code></pre></div><h2 id="六、实际部署方案-深圳图书馆的架构" tabindex="-1">六、实际部署方案（深圳图书馆的架构） <a class="header-anchor" href="#六、实际部署方案-深圳图书馆的架构" aria-label="Permalink to &quot;六、实际部署方案（深圳图书馆的架构）&quot;">​</a></h2><h3 id="生产环境架构图" tabindex="-1">生产环境架构图 <a class="header-anchor" href="#生产环境架构图" aria-label="Permalink to &quot;生产环境架构图&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># docker-compose 配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;3.8&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 主节点 - 福田主馆</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  mongodb-primary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mongo:6.0</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mongod --replSet shenzhen_lib --bind_ip_all</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;27017:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;primary_data:/data/db&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 从节点1 - 南山分馆</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  mongodb-secondary1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mongo:6.0</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mongod --replSet shenzhen_lib --bind_ip_all</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;27018:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;secondary1_data:/data/db&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 从节点2 - 宝安分馆</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  mongodb-secondary2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mongo:6.0</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mongod --replSet shenzhen_lib --bind_ip_all</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;27019:27017&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;secondary2_data:/data/db&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 监控面板</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  mongo-express</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mongo-express</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;8081:8081&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    environment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      ME_CONFIG_MONGODB_SERVER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mongodb-primary</span></span></code></pre></div><h3 id="数据同步优化" tabindex="-1">数据同步优化 <a class="header-anchor" href="#数据同步优化" aria-label="Permalink to &quot;数据同步优化&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 调整同步参数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cfg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">conf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cfg.settings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chainingAllowed: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 允许链式复制</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  heartbeatIntervalMillis: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  electionTimeoutMillis: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reconfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cfg);</span></span></code></pre></div><h2 id="七、常见问题与解决方案" tabindex="-1">七、常见问题与解决方案 <a class="header-anchor" href="#七、常见问题与解决方案" aria-label="Permalink to &quot;七、常见问题与解决方案&quot;">​</a></h2><h3 id="问题1-分馆同步太慢" tabindex="-1">问题1：分馆同步太慢 <a class="header-anchor" href="#问题1-分馆同步太慢" aria-label="Permalink to &quot;问题1：分馆同步太慢&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 原因：网络带宽不足</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 解决方案：优化oplog大小</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">adminCommand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  replSetResizeOplog: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  size: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20480</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 20GB的oplog</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 比喻：给分馆之间修高速公路</span></span></code></pre></div><h3 id="问题2-选举时间太长" tabindex="-1">问题2：选举时间太长 <a class="header-anchor" href="#问题2-选举时间太长" aria-label="Permalink to &quot;问题2：选举时间太长&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 原因：网络延迟高</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 解决方案：调整选举超时</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cfg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">conf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cfg.settings.electionTimeoutMillis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 5秒超时</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reconfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cfg);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 比喻：缩短&quot;馆长选举&quot;的讨论时间</span></span></code></pre></div><h3 id="问题3-脑裂问题" tabindex="-1">问题3：脑裂问题 <a class="header-anchor" href="#问题3-脑裂问题" aria-label="Permalink to &quot;问题3：脑裂问题&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 解决方案：设置奇数节点</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3个分馆 → 不会出现2:2的平局</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 5个分馆 → 需要3:2才能当选</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 如果只有偶数节点，加一个&quot;仲裁节点&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addArb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sz-lib-arbiter:27020&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 这个节点不存书，只负责投票</span></span></code></pre></div><h2 id="八、实践总结" tabindex="-1">八、实践总结 <a class="header-anchor" href="#八、实践总结" aria-label="Permalink to &quot;八、实践总结&quot;">​</a></h2><h3 id="图书馆复制集黄金法则" tabindex="-1">图书馆复制集黄金法则 <a class="header-anchor" href="#图书馆复制集黄金法则" aria-label="Permalink to &quot;图书馆复制集黄金法则&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bestPractices</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  rule1: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;至少3个节点（1主2从）&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  rule2: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;跨机房部署（不同行政区）&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  rule3: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;定期演练故障切换&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  rule4: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;监控同步延迟&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  rule5: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;设置合适的oplog大小&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h3 id="部署检查清单" tabindex="-1">部署检查清单 <a class="header-anchor" href="#部署检查清单" aria-label="Permalink to &quot;部署检查清单&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 初始化后的检查</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">检查项 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;主节点选举成功？&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isMaster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().ismaster,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;从节点同步正常？&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().members[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].stateStr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;SECONDARY&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;复制延迟 &lt; 5秒？&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: rs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printSlaveReplicationInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().lag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;有备份策略？&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">adminCommand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({listBackups: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;有监控告警？&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span></code></pre></div><h3 id="一句话说清区别" tabindex="-1">一句话说清区别 <a class="header-anchor" href="#一句话说清区别" aria-label="Permalink to &quot;一句话说清区别&quot;">​</a></h3><ul><li>分片集群：书太多，一个图书馆装不下，于是分成多个图书馆，每个放不同的书</li><li>复制集：图书馆太重要，不能停业，于是建几个一模一样的备份馆，随时能顶上</li></ul>`,52),p=[l];function t(k,e,E,r,d,g){return i(),a("div",{"data-pagefind-body":!0},p)}const y=s(h,[["render",t]]);export{c as __pageData,y as default};
